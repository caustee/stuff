#!/bin/sh

# Year Progress Widget - Cross-platform compatible
# Works with bash 3+, zsh, busybox sh, and other POSIX shells
# Author: Costin Stefan

year_progress() {
    # Get current date components using POSIX-compatible date command
    if command -v date >/dev/null 2>&1; then
        # Try different date formats for cross-platform compatibility
        if current_year=$(date +%Y 2>/dev/null) && current_day=$(date +%j 2>/dev/null); then
            # Remove leading zeros from day of year
            current_day=$(printf "%d" "$current_day" 2>/dev/null || echo "$current_day")
        else
            echo "Error: Unable to get current date"
            return 1
        fi
    else
        echo "Error: date command not available"
        return 1
    fi

    # Check if it's a leap year
    if [ $((current_year % 4)) -eq 0 ] && { [ $((current_year % 100)) -ne 0 ] || [ $((current_year % 400)) -eq 0 ]; }; then
        total_days=366
    else
        total_days=365
    fi

    # Calculate percentage (using integer arithmetic for compatibility)
    percentage=$((current_day * 100 / total_days))

    # Progress bar configuration
    bar_width=40
    filled_width=$((percentage * bar_width / 100))

    # Create progress bar using POSIX-compatible methods
    filled=""
    empty=""
    i=0
    while [ $i -lt $filled_width ]; do
        filled="${filled}█"
        i=$((i + 1))
    done

    i=0
    while [ $i -lt $((bar_width - filled_width)) ]; do
        empty="${empty}░"
        i=$((i + 1))
    done

    # Color codes (with fallback for systems without color support)
    if [ -t 1 ] && { [ "$TERM" != "dumb" ] && [ -n "$TERM" ]; }; then
        # Colors
#        PURPLE='\033[38;5;135m' ## works good on normal sessions where I'm sshing
        PURPLE='\033[96m' ## added to work on my dark background zsh terminal
        WHITE='\033[97m'
        GRAY='\033[37m'
#        GRAY='\033[90m' ## works good on normal sessions where I'm sshing
        RESET='\033[0m'  ## added to work on my dark background zsh terminal
        BOLD='\033[1m'
    else
        # No colors for non-terminal or dumb terminal
        PURPLE=""
        WHITE=""
        GRAY=""
        RESET=""
        BOLD=""
    fi

    # Calculate remaining days
    remaining_days=$((total_days - current_day))

    # Display the widget
    printf "\n"
    printf "${PURPLE}┌─────────────────────────────────────────────────────┐${RESET}\n"
    printf "${PURPLE}│${RESET}                   ${BOLD}${WHITE}YEAR PROGRESS${RESET}                     ${PURPLE}│${RESET}\n"
    printf "${PURPLE}│${RESET}                                                     ${PURPLE}│${RESET}\n"
    printf "${PURPLE}│${RESET}  ${WHITE}${filled}${GRAY}${empty}${RESET}  ${BOLD}${WHITE}%3d%%${RESET} ${PURPLE}    │${RESET}\n" "$percentage"
    printf "${PURPLE}│${RESET}                                                     ${PURPLE}│${RESET}\n"
    printf "${PURPLE}│${RESET}  ${WHITE}Day ${BOLD}%d${RESET}${WHITE} of %d${RESET}                    ${WHITE}%d days left${RESET} ${PURPLE}   │${RESET}\n" "$current_day" "$total_days" "$remaining_days"
    printf "${PURPLE}│${RESET}  ${GRAY}Year: %d${RESET}                                    ${PURPLE}     │${RESET}\n" "$current_year"
    printf "${PURPLE}└─────────────────────────────────────────────────────┘${RESET}\n"
    printf "\n"
}

# Run the function if script is executed directly
if [ "${0##*/}" = "year_progress" ] || [ "$0" = "/usr/local/bin/year_progress" ] || [ "$0" = "/bin/sh" ]; then
    year_progress
fi

